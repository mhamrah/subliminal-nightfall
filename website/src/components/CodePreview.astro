---
import { readFileSync } from "fs";
import { resolve } from "path";
import Prism from "prismjs";
import "prismjs/components/prism-go";
import "prismjs/components/prism-rust";
import "prismjs/components/prism-typescript";
import "prismjs/components/prism-swift";
import "prismjs/components/prism-bash";

const codeFiles = [
    {
        name: "Go",
        lang: "go",
        file: "example.go",
        icon: "ðŸ”·",
    },
    {
        name: "Rust",
        lang: "rust",
        file: "example.rs",
        icon: "ðŸ¦€",
    },
    {
        name: "TypeScript",
        lang: "typescript",
        file: "example.ts",
        icon: "ðŸ’™",
    },
    {
        name: "Swift",
        lang: "swift",
        file: "example.swift",
        icon: "ðŸŽ",
    },
    {
        name: "Shell",
        lang: "bash",
        file: "example.sh",
        icon: "ðŸ’»",
    },
];

// Read code samples and highlight them
const samples = codeFiles.map(({ name, lang, file, icon }) => {
    try {
        const filePath = resolve("./src/code-samples", file);
        const code = readFileSync(filePath, "utf-8");
        const highlighted = Prism.highlight(
            code,
            Prism.languages[lang] || Prism.languages.markup,
            lang,
        );
        return { name, lang, code, highlighted, icon };
    } catch (error) {
        return {
            name,
            lang,
            code: `// Error loading ${file}`,
            highlighted: `// Error loading ${file}`,
            icon,
        };
    }
});
---

<section id="examples" class="container mx-auto px-4 py-20">
    <div class="text-center mb-12">
        <h2 class="text-4xl font-bold text-sn-fg mb-4">Syntax Highlighting</h2>
        <p class="text-sn-fg-muted text-lg max-w-2xl mx-auto">
            See how Subliminal Nightfall looks across different programming
            languages with carefully calibrated syntax colors.
        </p>
    </div>

    <div class="max-w-6xl mx-auto">
        <!-- Tab buttons -->
        <div class="flex flex-wrap gap-2 mb-4 border-b border-sn-border">
            {
                samples.map((sample, index) => (
                    <button
                        class={`code-tab px-4 py-2 font-medium transition-all duration-200 border-b-2 ${
                            index === 0
                                ? "border-sn-cyan text-sn-cyan"
                                : "border-transparent text-sn-fg-muted hover:text-sn-fg hover:border-sn-border"
                        }`}
                        data-lang={sample.lang}
                    >
                        <span class="mr-2">{sample.icon}</span>
                        {sample.name}
                    </button>
                ))
            }
        </div>

        <!-- Code panels -->
        <div class="relative">
            {
                samples.map((sample, index) => (
                    <div
                        class={`code-panel backdrop-blur-xl bg-sn-bg/80 border border-sn-border/50 rounded-lg overflow-hidden shadow-2xl ${
                            index === 0 ? "" : "hidden"
                        }`}
                        data-lang={sample.lang}
                    >
                        <div class="flex items-center justify-between px-4 py-3 bg-sn-bg-alt/60 backdrop-blur-sm border-b border-sn-border/50">
                            <div class="flex items-center space-x-2">
                                <div class="flex space-x-1.5">
                                    <div class="w-3 h-3 rounded-full bg-sn-red" />
                                    <div class="w-3 h-3 rounded-full bg-sn-yellow" />
                                    <div class="w-3 h-3 rounded-full bg-sn-green" />
                                </div>
                                <span class="text-sm text-sn-fg-muted ml-4">
                                    {sample.name} Example
                                </span>
                            </div>
                            <button
                                class="copy-button flex items-center space-x-2 px-3 py-1 text-sm text-sn-fg-muted hover:text-sn-cyan transition-colors rounded"
                                data-code={sample.code}
                            >
                                <svg
                                    class="w-4 h-4"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"
                                    />
                                </svg>
                                <span>Copy</span>
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <pre class="p-6 text-sm leading-relaxed">
                                <code
                                    class={`language-${sample.lang}`}
                                    set:html={sample.highlighted}
                                />
                            </pre>
                        </div>
                    </div>
                ))
            }
        </div>
    </div>
</section>

<style>
    pre {
        margin: 0;
        background: transparent;
        font-family: "JetBrains Mono", "Fira Code", "Cascadia Code", monospace;
    }

    code {
        display: block;
        color: var(--color-sn-fg);
    }

    .code-panel {
        backdrop-filter: blur(24px);
        -webkit-backdrop-filter: blur(24px);
    }

    /* Prism syntax highlighting using theme colors */
    :global(.token.keyword),
    :global(.token.control),
    :global(.token.directive) {
        color: var(--color-sn-blue-green);
    }

    :global(.token.function),
    :global(.token.function-name) {
        color: var(--color-sn-teal);
    }

    :global(.token.string),
    :global(.token.char) {
        color: var(--color-sn-teal);
    }

    :global(.token.number),
    :global(.token.boolean),
    :global(.token.constant) {
        color: var(--color-sn-lavender);
    }

    :global(.token.comment),
    :global(.token.prolog),
    :global(.token.doctype),
    :global(.token.cdata) {
        color: var(--color-sn-fg-dim);
        font-style: italic;
    }

    :global(.token.builtin),
    :global(.token.class-name),
    :global(.token.type-annotation),
    :global(.token.type-declaration) {
        color: var(--color-sn-blue-green);
    }

    :global(.token.operator) {
        color: var(--color-sn-magenta);
    }

    :global(.token.entity),
    :global(.token.url) {
        color: var(--color-sn-cyan);
    }

    :global(.token.property),
    :global(.token.tag),
    :global(.token.selector) {
        color: var(--color-sn-cyan);
    }

    :global(.token.attr-name),
    :global(.token.attribute),
    :global(.token.macro),
    :global(.token.decorator) {
        color: var(--color-sn-magenta);
        font-style: italic;
    }

    :global(.token.punctuation) {
        color: var(--color-sn-fg-muted);
    }

    :global(.token.variable) {
        color: var(--color-sn-fg);
    }

    :global(.token.namespace) {
        color: var(--color-sn-lavender);
    }

    :global(.token.regex),
    :global(.token.important) {
        color: var(--color-sn-yellow);
    }
</style>

<script>
    // Tab switching
    const tabs = document.querySelectorAll(".code-tab");
    const panels = document.querySelectorAll(".code-panel");

    tabs.forEach((tab) => {
        tab.addEventListener("click", () => {
            const lang = tab.getAttribute("data-lang");

            // Update active tab
            tabs.forEach((t) => {
                t.classList.remove("border-sn-cyan", "text-sn-cyan");
                t.classList.add("border-transparent", "text-sn-fg-muted");
            });
            tab.classList.remove("border-transparent", "text-sn-fg-muted");
            tab.classList.add("border-sn-cyan", "text-sn-cyan");

            // Update visible panel
            panels.forEach((panel) => {
                if (panel.getAttribute("data-lang") === lang) {
                    panel.classList.remove("hidden");
                } else {
                    panel.classList.add("hidden");
                }
            });
        });
    });

    // Copy code functionality
    const copyButtons = document.querySelectorAll(".copy-button");

    copyButtons.forEach((button) => {
        button.addEventListener("click", async () => {
            const code = button.getAttribute("data-code");
            if (code) {
                try {
                    await navigator.clipboard.writeText(code);
                    const span = button.querySelector("span");
                    if (span) {
                        const originalText = span.textContent;
                        span.textContent = "Copied!";
                        setTimeout(() => {
                            span.textContent = originalText;
                        }, 2000);
                    }
                } catch (err) {
                    console.error("Failed to copy code:", err);
                }
            }
        });
    });
</script>
