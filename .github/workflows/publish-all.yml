name: Publish Themes and Website

on:
  push:
    branches: [ main ]
    paths:
      - 'theme.toml'
      - 'packages/core/**'
      - 'cursor/**'
      - 'zed/**'
      - 'ghostty/**'
      - 'neovim/**'
  push:
    branches: [ main ]
    paths:
      - 'website/**'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: Install pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10.11.1

      - name: Install dependencies
        run: pnpm install

      - name: Generate themes
        run: pnpm gen:themes || cargo run --manifest-path tools/themegen/Cargo.toml -- -c theme.toml generate

      - name: Build website
        run: pnpm --filter website build || echo 'Website build failed'

      - name: Upload website artifact
        uses: actions/upload-artifact@v4
        with:
          name: website-dist
          path: website/dist

      - name: Auto-bump VS Code/Cursor patch version
        working-directory: cursor
        run: |
          node -e "const fs=require('fs'); const p=JSON.parse(fs.readFileSync('package.json','utf8')); const v=p.version.split('.').map(Number); v[2]++; p.version=v.join('.'); fs.writeFileSync('package.json', JSON.stringify(p,null,2)+'\n'); console.log('Cursor new version:', p.version);"

      - name: Publish VS Code / Cursor Extension
        working-directory: cursor
        env:
          VSCE_PAT: ${{ secrets.VSCE_TOKEN }}
          OVSX_PAT: ${{ secrets.OPEN_VSX_TOKEN }}
        run: |
          npm install -g @vscode/vsce ovsx
          vsce publish --pat "$VSCE_PAT" || echo "VSCE publish skipped"
          ovsx publish --pat "$OVSX_PAT" || echo "OVSX publish skipped"

      - name: Tag for Zed Extension Release
        if: startsWith(github.ref, 'refs/heads/main')
        run: |
          VERSION=$(node -e "process.stdout.write(require('./cursor/package.json').version)")
          TAG="v$VERSION"
          echo "Tagging release $TAG"
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "Tag $TAG already exists, skipping";
          else
            git tag "$TAG"
            git push origin "$TAG" || echo "Failed to push tag"
          fi

      - name: Prepare Zed Extension Release PR
        uses: huacnlee/zed-extension-action@v1
        with:
          extension-name: subliminal-nightfall
          extension-path: .
          push-to: ${{ vars.zed_extension_fork }}
        env:
          COMMITTER_TOKEN: ${{ secrets.ZED_COMMITTER_TOKEN }}

      - name: Deploy Website to Cloudflare Pages
        if: success()
        working-directory: website
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          npm install -g wrangler
          if [ -n "$CLOUDFLARE_API_TOKEN" ]; then
            wrangler pages deploy dist --project-name=subliminal-nightfall || echo "Cloudflare deploy failed"
          else
            echo "No token; skipping deploy"
          fi

      - name: Bump core package version if theme.toml changed
        if: contains(toJSON(github.event.commits), 'theme.toml')
        run: |
          node -e "const fs=require('fs'); const p=JSON.parse(fs.readFileSync('packages/core/package.json','utf8')); const v=p.version.split('.').map(Number); v[2]++; p.version=v.join('.'); fs.writeFileSync('packages/core/package.json', JSON.stringify(p,null,2)+'\n'); console.log('Core new version:', p.version);"

      - name: Update extension.toml version to match latest tag
        run: |
          if [ -f extension.toml ]; then
            CURR=$(grep '^version' extension.toml | cut -d'"' -f2 || echo '0.0.0');
            NEW=$(node -e "const fs=require('fs');const p=JSON.parse(fs.readFileSync('cursor/package.json','utf8'));process.stdout.write(p.version)");
            sed -i "s/version = \"$CURR\"/version = \"$NEW\"/" extension.toml || true;
            echo "extension.toml version updated to $NEW";
          fi

      - name: Commit version bumps
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add cursor/package.json packages/core/package.json extension.toml || true
          if git diff --cached --quiet; then
            echo "No version changes to commit"; else
            git commit -m "chore: bump versions [skip ci]" || true
            git push || echo "Push failed";
          fi
